## HTTP缓存协议

如果响应报文的响应头中含有以下字段:

```xml
Cache-Control: max-age=3600
ETag: 资源编号
Date: 响应时的日期，GMT
Last-Modified: 该资源上次修改时的日期,GMT
```

浏览器看到该响应头，就会把本次响应收到的资源缓存到本地磁盘

- 浏览器把本次请求响应体缓存到本地磁盘
- 标记该请求的 方法 和 请求路径
- 标记该本次缓存的可用时间
- ...



## 协商缓存

浏览器在发送一个请求时，会先尝试查询缓存

具体流程如下：

1. 缓存中是否有匹配本次请求方法和路径的资源
2. 如果有，该缓存是否有效

### 缓存命中

如果浏览器匹配到了有效的缓存资源

就不会请求服务器，而是直接使用本地资源。

就算服务器已经更改了资源，浏览器也是不知道的，只要缓存有效它就会使用缓存

### 缓存失效

如果缓存失效，浏览器就会询问服务器该缓存能否继续使用

就会发送一个带缓存的请求（协商缓存）

```xml
If-Modified-Since: 响应该缓存的时间
If-None-Match: 该缓存的资源编号
```

询问服务器，自从上次响应后，该资源有没有发生改变？资源编号有没有改变？

之所以要发送这两个信息，是为了兼容不同的服务器

有些服务器只认`If-Modified-Since` , 有些服务器认 `If-None-Match`, 有些则都认

> `If-Modified-Since` 是 `Http 1.0` 版本规范
>
> `If-None-Match` 是 `Http 1.1` 版本规范



**服务器响应：缓存失效**

如果服务器表示缓存已经失效，那么就会发送一个正常的响应

- 该响应的状态码为 `200` 
- 带响应体

- 同时可以附带新的缓存指令

然后浏览器就会重新缓存



**服务器响应：缓存有效**

如果服务器表示缓存可以继续使用，就会响应一个特殊的结果

- 响应状态码：`304` `Not Modified`
- 无响应体
- 响应头附带新的缓存指令

浏览器继续使用缓存，更新缓存标记内容



